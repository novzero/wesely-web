<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Document</title>
	<link rel="stylesheet" href="/css/font.css" />
	<link rel="stylesheet" href="/css/header.css" />
	<link rel="stylesheet" href="/css/store/placeList.css" />
	<script src="https://kit.fontawesome.com/a9ad5c8c5b.js" crossorigin="anonymous"></script>
	<script>
		// ë”ë³´ê¸°ë²„íŠ¼ í´ë¦­ì‹œ 12ê°œì”© ê°€ì ¸ì˜¤ê¸° ìœ„í•´ ì´ˆê¸° Num0ì…‹íŒ…
		let lastNum = 0;
		window.onload = function () {
			//storeMore();
			//placesSearchCB();
		}
	</script>
	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=04aea75b3d77e8dc37d083dd6b9d6eb4&libraries=services"></script>
	<script>
		let latitude;
		let longitude;
		var allPlaces;  // ì „ì—­ë³€ìˆ˜ë¡œ ì„ ì–¸
		// ì¥ì†Œ ê²€ìƒ‰ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤
		var ps = new kakao.maps.services.Places();

		// í˜„ì¬ ìœ„ì¹˜ì˜ ìœ„ë„, ê²½ë„ ì•Œì•„ë‚´ê¸°
		navigator.geolocation.getCurrentPosition((position) => {
			latitude = position.coords.latitude;
			longitude = position.coords.longitude;

			// ì•Œì•„ë‚¸ ìœ„ë„,ê²½ë„ë¥¼ kakaoAPIë¡œ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ ë²•ì •ë™ìœ¼ë¡œ ë°›ì•„ë‚´ê¸°
			geocoder.coord2RegionCode(longitude, latitude, callback);
		});

		var geocoder = new kakao.maps.services.Geocoder();

		var callback = function (result, status) {
			if (status === kakao.maps.services.Status.OK) {

				console.log(result[0].region_1depth_name);
				console.log(result[0].region_3depth_name);


				// í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ 00ì‹œ 00êµ¬ 00ë™
				document.getElementById('currentLocation').innerText =
					result[0].region_1depth_name + " " +
					result[0].region_2depth_name + " " +
					result[0].region_3depth_name;

				// í˜„ì¬ ìœ„ì¹˜ 00ì‹œ 00ë™ìœ¼ë¡œ ê²€ìƒ‰
				let region = result[0].region_1depth_name + result[0].region_3depth_name;
				const loc = result[0].region_2depth_name + result[0].region_3depth_name;
				var searchKeywords = ['ìš”ê°€', 'í—¬ìŠ¤', 'í•„ë¼í…ŒìŠ¤'];

				var searchPromises = searchKeywords.map(keyword => {
					return new Promise((resolve, reject) => {
						ps.keywordSearch(region + keyword, (data, status) => {
							if (status === kakao.maps.services.Status.OK) {
								// data ë°°ì—´ì˜ ê° ìš”ì†Œì— ëŒ€í•´ loc ì†ì„± ì¶”ê°€
								data.forEach(item => {
									item.loc = loc;
								});
								resolve(data);

							} else {
								reject(status);
							}
						}, {page: 1, size: 15});
					});
				});


				Promise.all(searchPromises)
					.then(results => {
						// Flatten the array of arrays into a single array
						allPlaces = [].concat(...results);
						console.log(allPlaces);
						sendLocation(loc)
						// Extract the id of each place and send to server
						sendKakaoIds(allPlaces.map(place => (place.id)));
					})
					.catch(error => console.error(error));
			}
		};

		function sendLocation(loc) {
			console.log(loc);
			fetch('/api/getStoreByLoc', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: loc
			})
				.then(response => response.json())
				.then(data => {
					console.log(data);
					let content = "";
					data.forEach(store => {
						let imgSrc;
						if (store.imgList.length > 0) {
							imgSrc = `/ static / images / upload / ${store.imgList[0].uuid}_${store.imgList[0].fileName} `;
						} else {
							console.log('imgList is empty');
							imgSrc = '/images/unpostImg.png';
						}
						content += `
						<div class="placeItem" id="placeItem">
							<a href="/store/view/${store.id}">
								<div class="hoverImgBox">
									<img src="${imgSrc}" alt="ì‹œì„¤ì´ë¯¸ì§€" />
								</div>
								<div class="placeTextBox">
									<div class="storeTitle">
										<span>${store.name}</span>
										<span>â­ ${store.averageStar}</span>
									</div>
									<p class="storeLocation">${store.address}</p>
                                	<!-- ğŸ‘‡í•´ì‹œíƒœê·¸ ë¦¬ìŠ¤íŠ¸ë„ ë™ì ìœ¼ë¡œ ìƒì„±í•˜ë ¤ë©´ ì¶”ê°€ì ì¸ ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤ -->
									<!--ì´ ë¶€ë¶„ì€ store ê°ì²´ì˜ êµ¬ì¡°ì™€ ë°ì´í„° í˜•íƒœì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤-->
									<div class="hashTagList">
									<p class="hashTag">#í—¬ìŠ¤ì¥</p>
									<p class="hashTag">#ì—ë„ˆì§€ ë„˜ì¹˜ëŠ”</p>
									</div>
								</div >
							</a >
               			</div >`;
					});
					const storeListElement = document.getElementById('mainContent');
					// ëª¨ë“  HTML ë¬¸ìì—´ì„ í•œ ë²ˆì— innerHTML ì— í• ë‹¹
					storeListElement.innerHTML = content;
				})
				.catch((e) => console.log(e));
		}

		function sendKakaoIds(kakaoPlaces) {
			console.log(kakaoPlaces);
			fetch('/api/getStoresByIds', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify(kakaoPlaces)
			})
				.then(response => response.json())
				.then(data => {
					console.log(data);
					allPlaces.forEach(place => {
						let store = data.find(s => s.kakaoId === place.id);
						let content = "";
						if (store) {
							let imgSrc;
							if (store.imgList.length > 0) {
								imgSrc = `/static/images/upload/${store.imgList[0].uuid}_${store.imgList[0].fileName}`;
							} else {
								imgSrc = '/images/unpostImg.png';
							}

							// store ê°ì²´ë¥¼ ì´ìš©í•´ HTML ìƒì„±
							content += `
                			<div class="placeItem" id="placeItem">
                    			<a href="/store/view/${store.id}">
                        			<div class="hoverImgBox">
                            			<img src="${imgSrc}" alt="ì‹œì„¤ì´ë¯¸ì§€" />
                        			</div>
                        			<div class="placeTextBox">
                            			<div class="storeTitle">
                                			<span>${place.place_name}</span>
                                			<span>â­ ${store.averageStar}</span>
                            			</div>
                            			<p class="storeLocation">${place.address_name}</p>
                            			<!-- í•´ì‹œíƒœê·¸ ë¦¬ìŠ¤íŠ¸ ë™ì ìœ¼ë¡œ ìƒì„± -->
                            			<!-- ì´ ë¶€ë¶„ì€ store ê°ì²´ì˜ êµ¬ì¡°ì™€ ë°ì´í„° í˜•íƒœì— ë”°ë¼ ë‹¬ë¼ì§‘ë‹ˆë‹¤ -->
                            			<!-- ì˜ˆ: #í—¬ìŠ¤ì¥, #ì—ë„ˆì§€ ë„˜ì¹˜ëŠ” ë“± -->
                            			<div class="hashTagList">
                                			<p class="hashTag">${store.hashTag}</p>
                            			</div>
                        			</div >
                    			</a >
                			</div>`;
						} else {
							// place ê°ì²´ë¥¼ ì´ìš©í•´ HTML ìƒì„±
							content += `
                 	<div class="placeItem" id="placeItem" onclick="selectPlace(this)" data-place='${place}'>
                   		<a href="/store/view/ka/${place.id}">
                      		<div class="hoverImgBox">
                         		<img src="/images/unpostImg.png" alt="${place.place_name}" />
                      		</div>
                      		<div class="placeTextBox">
                          		<div class="storeTitle">
                              		<span>${place.place_name}</span>
                              		<span>â­ 0</span> 
                          		</div>
                          		<p class='storeLocation'>${place.address_name}</p> 
                          	
                          	 	<!-- ì¹´ì¹´ì˜¤ APIì—ì„œ ì œê³µí•˜ëŠ” ì¹´í…Œê³ ë¦¬ ì •ë³´ë¡œ í•´ì‹œíƒœê·¸ ë¦¬ìŠ¤íŠ¸ ë™ì ìœ¼ë¡œ ìƒì„± -->
                             	<!-- ì˜ˆ: #ìŠ¤í¬ì¸ ,ë ˆì €, #ìš”ê°€,í•„ë¼í…ŒìŠ¤, #ìš”ê°€ì› -->
                          		<div class="hashTagList">
                              		<p class="hashTag">#${place.category_name.split('>').join('#')}</p>
                          		</div>
                      		</div >
                   	 	</a>
                 	</div>`;
						}

						const storeListElement = document.getElementById('mainContent');
						// ëª¨ë“  HTML ë¬¸ìì—´ì„ í•œ ë²ˆì— innerHTML ì— í• ë‹¹
						storeListElement.innerHTML += content;
					});
				})
				.catch((e) => console.log(e));

		}
	</script>
</head>

<body>

	<div class="wrapper">
		<header>
			<div class="logo">
				<a href="/">
					<img src="/images/weLogo.png" alt="Logo" />
				</a>
			</div>
			<nav class="bar">
				<a href="/store/"><strong>ìš´ë™ì‹œì„¤ê²€ìƒ‰</strong></a>
				<a href="/community/"><strong>ì»¤ë®¤ë‹ˆí‹°</strong></a>
				<a href="/"><strong>ê³ ê°ì„¼í„°</strong></a>
			</nav>
			<nav class="hello">
				<th:block th:if="${session.mvo != null}">
					<span>
						<!-- ë³„ëª…ì„ ì„¤ì •í•˜ì§€ ì•Šì€ íšŒì›ì€ ì´ë¦„ìœ¼ë¡œ í‘œì‹œëœë‹¤. -->
						<input type="text" th:value="${session.mvo.nickname}" disabled />
						ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.
					</span>
				</th:block>
			</nav>

			<nav class="login">
				<th:block th:if="${session.mvo == null}">
					<a href="/member/login"><strong>ë¡œê·¸ì¸</strong></a>
					<a href="/member/join"><strong>íšŒì›ê°€ì…</strong></a>
				</th:block>

				<th:block th:if="${session.mvo != null && session.mvo.authority == 'ì¼ë°˜ê³„ì •'}">
					<a href="/member/updateProfile"><strong>ë§ˆì´í˜ì´ì§€</strong></a>
					<a href="/member/logout"><strong>ë¡œê·¸ì•„ì›ƒ</strong></a>
				</th:block>

				<th:block th:if="${session.mvo != null && session.mvo.authority == 'ë¹„ì¦ˆë‹ˆìŠ¤ê³„ì •'}">
					<a href="/member/updateProfile"><strong>íšŒì›ì •ë³´ìˆ˜ì •</strong></a>
					<a th:href="@{/store/view/b/{userId}(userId=${session.mvo.userid})}"><strong>ë§¤ì¥ê´€ë¦¬</strong></a>
					<a href="/member/logout"><strong>ë¡œê·¸ì•„ì›ƒ</strong></a>
				</th:block>
			</nav>
		</header>

		<!-- ğŸ‘‡ì—¬ê¸°ë¶€í„° ì£¼ë³€ì‹œì„¤ëª©ë¡ë“¤ -->
		<main>
			<div class="mainList">
				<div class="mainTitle">
					<div class="mainTextBox">
						<h2>ë‚´ ì£¼ë³€ì˜ ìš´ë™ì‹œì„¤</h2>
						<h2>100% ì¦ê¸°ê¸°</h2>
						<p>ë‚˜ì™€ ê¼­ ë§ëŠ” ìš´ë™ì‹œì„¤ì°¾ê¸°, ë¦¬ë·°ë¥¼ í†µí•´ í™•ì¸í•´ë³´ì„¸ìš”.</p>
					</div>

					<div class="line"></div>

					<div class="mainIconBox">
						<div class="currentPlace">
							<img src="/images/ic.png" alt="ë§ˆì»¤ì•„ì´ì½˜" />
							<p id="currentLocation"></p>
						</div>
						<div class="searchBtn">
							<button th:onclick="location.href='/store/search'">ì§€ë„ë¡œ ì‹œì„¤ê²€ìƒ‰</button>
							<img src="/images/icon_search.png" alt="ì„œì¹˜ì•„ì´ì½˜" />
						</div>
					</div>
				</div>


				<div class="mainContent" id="mainContent">

				</div>
			</div>

			<button class="btnSeeMore" id="loadMoreButton" onclick="storeMore()">
				<span>ì‹œì„¤ ë”ë³´ê¸°</span>
				<i class="fa-solid fa-chevron-down"></i>
			</button>
		</main>
	</div>
</body>

</html>